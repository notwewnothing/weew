import 'package:auto_route/auto_route.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'dart:math' as math;
import 'dart:ui' as ui;

// Packages
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:media_kit/media_kit.dart';
import 'package:google_fonts/google_fonts.dart';

// Spotube Imports (Keep these as they match your project structure)
import 'package:spotube/features/retro_player/providers/retro_player_provider.dart';
import 'package:spotube/services/audio_player/audio_player.dart';
import 'package:spotube/provider/lyrics/synced.dart';

/// Professional MD Vinyl-style player screen with realistic vinyl mechanics
@RoutePage()
class VinylPlayerScreen extends HookConsumerWidget {
  const VinylPlayerScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // -------------------------------------------------------------------------
    // PROVIDERS & STATE
    // -------------------------------------------------------------------------
    final playerState = ref.watch(retroPlayerStateProvider);
    final progress = ref.watch(retroPlaybackProgressProvider);
    final playing = ref.watch(retroPlayingProvider);
    final loopMode = ref.watch(retroPlaylistModeProvider);
    final position = ref.watch(retroPositionProvider);
    final size = MediaQuery.of(context).size;

    // Data Extraction
    final currentTrack = playerState.activeTrack;
    final album = currentTrack?.album;
    final images = album?.images;
    final firstImage = images?.firstOrNull;
    final albumArtUrl = firstImage?.url ?? '';

    final trackTitle = currentTrack?.name ?? 'Unknown Track';
    final artists = currentTrack?.artists;
    final firstArtist = artists?.firstOrNull;
    final artistName = firstArtist?.name ?? 'Unknown Artist';

    final isLandscape = size.width > size.height;

    // Lyrics
    final lyricsQuery = ref.watch(syncedLyricsProvider(currentTrack));

    return Focus(
      onKey: (node, event) {
        if (event.isKeyPressed(LogicalKeyboardKey.escape)) {
          Navigator.of(context).pop();
          return KeyEventResult.handled;
        }
        return KeyEventResult.ignored;
      },
      child: Scaffold(
        backgroundColor: const Color(0xFF0A0A0A), // Deepest Black
        body: Stack(
          children: [
            // -----------------------------------------------------------------
            // 1. DYNAMIC BACKGROUND
            // -----------------------------------------------------------------
            if (albumArtUrl.isNotEmpty)
              Positioned.fill(
                child: ImageFiltered(
                  imageFilter: ui.ImageFilter.blur(sigmaX: 30, sigmaY: 30),
                  child: Image.network(
                    albumArtUrl,
                    fit: BoxFit.cover,
                    opacity: const AlwaysStoppedAnimation(0.6), // Dimmed
                    errorBuilder: (_, __, ___) =>
                        Container(color: Colors.grey[900]),
                  ),
                ),
              ),

            // Vignette & Mesh Overlay for "Mood"
            Positioned.fill(
              child: Container(
                decoration: BoxDecoration(
                  gradient: RadialGradient(
                    center: Alignment.center,
                    radius: 1.5,
                    colors: [
                      Colors.transparent,
                      Colors.black.withOpacity(0.8),
                      Colors.black,
                    ],
                    stops: const [0.2, 0.8, 1.0],
                  ),
                ),
              ),
            ),

            // -----------------------------------------------------------------
            // 2. APP BAR / NAVIGATION
            // -----------------------------------------------------------------
            SafeArea(
              child: Align(
                alignment: Alignment.topLeft,
                child: IconButton(
                  icon: const Icon(Icons.keyboard_arrow_down_rounded,
                      color: Colors.white, size: 32),
                  onPressed: () => Navigator.of(context).pop(),
                ),
              ),
            ),

            // -----------------------------------------------------------------
            // 3. MAIN CONTENT LAYOUT
            // -----------------------------------------------------------------
            SafeArea(
              child: isLandscape
                  ? _buildLandscapeLayout(
                      context,
                      progress,
                      playing,
                      albumArtUrl,
                      trackTitle,
                      artistName,
                      position,
                      loopMode,
                      lyricsQuery,
                    )
                  : _buildPortraitLayout(
                      context,
                      progress,
                      playing,
                      albumArtUrl,
                      trackTitle,
                      artistName,
                      position,
                      loopMode,
                      lyricsQuery,
                    ),
            ),
          ],
        ),
      ),
    );
  }

  // ===========================================================================
  // LAYOUTS
  // ===========================================================================

  Widget _buildLandscapeLayout(
    BuildContext context,
    AsyncValue<double> progress,
    AsyncValue<bool> playing,
    String? albumArtUrl,
    String trackTitle,
    String artistName,
    AsyncValue<Duration> position,
    AsyncValue<PlaylistMode> loopMode,
    AsyncValue<dynamic> lyricsQuery,
  ) {
    final size = MediaQuery.of(context).size;
    final vinylSize = math.min(size.width * 0.45, size.height * 0.85);

    return Row(
      children: [
        // Left: Vinyl
        Expanded(
          flex: 55,
          child: Center(
            child: progress.when(
              data: (progressValue) => _buildVinylVisualization(
                progressValue,
                playing.maybeWhen(data: (p) => p, orElse: () => false),
                albumArtUrl,
                size: vinylSize,
              ),
              loading: () =>
                  CircularProgressIndicator(color: Colors.amber[400]),
              error: (_, __) => Container(),
            ),
          ),
        ),

        // Right: Controls & Info
        Expanded(
          flex: 45,
          child: Padding(
            padding: const EdgeInsets.only(right: 32, top: 24, bottom: 24),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                _buildMetadataHeader(trackTitle, artistName),
                const SizedBox(height: 16),
                _buildProgressBar(progress),
                const SizedBox(height: 16),
                Expanded(child: _buildSyncedLyricsPanel(lyricsQuery, position)),
                const SizedBox(height: 16),
                _buildNowPlayingCard(position),
                const SizedBox(height: 16),
                _buildControlsPanel(loopMode, position, playing),
              ],
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildPortraitLayout(
    BuildContext context,
    AsyncValue<double> progress,
    AsyncValue<bool> playing,
    String? albumArtUrl,
    String trackTitle,
    String artistName,
    AsyncValue<Duration> position,
    AsyncValue<PlaylistMode> loopMode,
    AsyncValue<dynamic> lyricsQuery,
  ) {
    final size = MediaQuery.of(context).size;
    final vinylSize = math.min(size.width * 0.85, size.height * 0.45);

    return SingleChildScrollView(
      physics: const BouncingScrollPhysics(),
      child: Column(
        children: [
          const SizedBox(height: 16),
          // Vinyl
          progress.when(
            data: (progressValue) => _buildVinylVisualization(
              progressValue,
              playing.maybeWhen(data: (p) => p, orElse: () => false),
              albumArtUrl,
              size: vinylSize,
            ),
            loading: () => SizedBox(
              width: vinylSize,
              height: vinylSize,
              child: Center(
                  child: CircularProgressIndicator(color: Colors.amber[400])),
            ),
            error: (_, __) => const SizedBox.shrink(),
          ),
          const SizedBox(height: 32),

          // Info
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24),
            child: _buildMetadataHeader(trackTitle, artistName, centered: true),
          ),
          const SizedBox(height: 24),

          // Progress
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24),
            child: _buildProgressBar(progress),
          ),
          const SizedBox(height: 24),

          // Lyrics
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24),
            child: SizedBox(
              height: 180,
              child: _buildSyncedLyricsPanel(lyricsQuery, position),
            ),
          ),
          const SizedBox(height: 24),

          // Controls
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24),
            child: Column(
              children: [
                _buildNowPlayingCard(position),
                const SizedBox(height: 16),
                _buildControlsPanel(loopMode, position, playing),
              ],
            ),
          ),
          const SizedBox(height: 32),
        ],
      ),
    );
  }

  // ===========================================================================
  // COMPONENTS
  // ===========================================================================

  Widget _buildMetadataHeader(String title, String artist,
      {bool centered = false}) {
    return Column(
      crossAxisAlignment:
          centered ? CrossAxisAlignment.center : CrossAxisAlignment.start,
      children: [
        Text(
          title,
          textAlign: centered ? TextAlign.center : TextAlign.start,
          style: GoogleFonts.orbitron(
              color: Colors.white,
              fontSize: 22,
              fontWeight: FontWeight.w700,
              letterSpacing: 1.0,
              shadows: [
                BoxShadow(color: Colors.amber.withOpacity(0.3), blurRadius: 10),
              ]),
          maxLines: 2,
          overflow: TextOverflow.ellipsis,
        ),
        const SizedBox(height: 8),
        Text(
          artist,
          textAlign: centered ? TextAlign.center : TextAlign.start,
          style: GoogleFonts.outfit(
            color: Colors.white70,
            fontSize: 16,
            fontWeight: FontWeight.w300,
            letterSpacing: 0.5,
          ),
        ),
      ],
    );
  }

  Widget _buildProgressBar(AsyncValue<double> progress) {
    return ClipRRect(
      borderRadius: BorderRadius.circular(4),
      child: LinearProgressIndicator(
        value: progress.maybeWhen(data: (p) => p, orElse: () => 0),
        minHeight: 4,
        backgroundColor: Colors.white.withOpacity(0.1),
        valueColor: AlwaysStoppedAnimation<Color>(Colors.amber[400]!),
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // VINYL & TONEARM VISUALIZATION (THE CORE)
  // ---------------------------------------------------------------------------
  Widget _buildVinylVisualization(
    double progress,
    bool isPlaying,
    String? albumArtUrl, {
    double size = 280,
  }) {
    return SizedBox(
      width: size + 40,
      height: size + 40,
      child: Stack(
        alignment: Alignment.center,
        children: [
          // 1. Plinth (Base) with Shadow
          Container(
            width: size,
            height: size,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              color: const Color(0xFF111111),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.6),
                  blurRadius: 30,
                  offset: const Offset(0, 15),
                ),
              ],
            ),
          ),

          // 2. Rotating Record
          Transform.rotate(
            angle: progress * 2 * math.pi * (isPlaying ? 5 : 0),
            child: SizedBox(
              width: size * 0.95,
              height: size * 0.95,
              child: Stack(
                alignment: Alignment.center,
                children: [
                  // High Fidelity Grooves & Sheen
                  CustomPaint(
                    size: Size(size * 0.95, size * 0.95),
                    painter: HighFidelityVinylPainter(),
                  ),

                  // Album Art Label (Recessed)
                  Container(
                    width: size * 0.38,
                    height: size * 0.38,
                    decoration: BoxDecoration(
                      shape: BoxShape.circle,
                      boxShadow: [
                        BoxShadow(
                            color: Colors.black.withOpacity(0.8),
                            blurRadius: 5),
                      ],
                      border:
                          Border.all(color: const Color(0xFF111111), width: 1),
                    ),
                    child: ClipOval(
                      child: albumArtUrl != null && albumArtUrl.isNotEmpty
                          ? Image.network(albumArtUrl, fit: BoxFit.cover)
                          : Container(color: Colors.grey[900]),
                    ),
                  ),

                  // Spindle (Metal)
                  Container(
                    width: 12,
                    height: 12,
                    decoration: BoxDecoration(
                      shape: BoxShape.circle,
                      gradient: RadialGradient(
                        colors: [Colors.grey[300]!, Colors.grey[800]!],
                        center: Alignment.topLeft,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),

          // 3. Tonearm (Preserved Logic, Updated Visuals)
          Positioned(
            top: size * 0.05,
            right: size * 0.05,
            child: _buildToneArm(progress, size),
          ),
        ],
      ),
    );
  }

  Widget _buildToneArm(double progress, double recordSize) {
    // PRESERVED LOGIC: Angle calculation
    final angleRotation = progress * 30;

    return Transform.rotate(
      angle: angleRotation * 0.0174533, // Radians conversion
      alignment: Alignment.topCenter,
      child: Container(
        width: 16, // Slightly wider for better detail
        height: recordSize * 0.55,
        decoration: BoxDecoration(
          // Carbon Fiber Look
          gradient: LinearGradient(
            begin: Alignment.centerLeft,
            end: Alignment.centerRight,
            colors: [
              const Color(0xFF2B2B2B),
              const Color(0xFF454545),
              const Color(0xFF1A1A1A),
            ],
          ),
          borderRadius: BorderRadius.circular(8),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.5),
              blurRadius: 5,
              offset: const Offset(4, 4),
            ),
          ],
        ),
        child: Stack(
          alignment: Alignment.bottomCenter,
          children: [
            // Counterweight (Top)
            Positioned(
              top: 5,
              child: Container(
                width: 24,
                height: 24,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  color: const Color(0xFF555555),
                  border: Border.all(color: Colors.grey[700]!, width: 2),
                ),
              ),
            ),

            // Headshell (Bottom) with LED
            Positioned(
              bottom: 0,
              child: Container(
                width: 20,
                height: 32,
                decoration: BoxDecoration(
                  color: const Color(0xFF222222),
                  borderRadius:
                      const BorderRadius.vertical(bottom: Radius.circular(4)),
                  border: Border.all(color: Colors.grey[800]!),
                ),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.end,
                  children: [
                    // The "Needle" / LED Tip
                    Container(
                      margin: const EdgeInsets.only(bottom: 4),
                      width: 4,
                      height: 4,
                      decoration: BoxDecoration(
                        color: Colors.redAccent,
                        shape: BoxShape.circle,
                        boxShadow: [
                          BoxShadow(
                              color: Colors.redAccent.withOpacity(0.8),
                              blurRadius: 6,
                              spreadRadius: 2),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  // ---------------------------------------------------------------------------
  // INFO & CONTROLS
  // ---------------------------------------------------------------------------

  Widget _buildNowPlayingCard(AsyncValue<Duration> position) {
    return ClipRRect(
      borderRadius: BorderRadius.circular(16),
      child: BackdropFilter(
        filter: ui.ImageFilter.blur(sigmaX: 10, sigmaY: 10),
        child: Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: Colors.white.withOpacity(0.05),
            border: Border.all(color: Colors.white.withOpacity(0.1)),
            borderRadius: BorderRadius.circular(16),
          ),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              // Time Code
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text('TIME',
                      style: GoogleFonts.rajdhani(
                          color: Colors.amber,
                          fontWeight: FontWeight.bold,
                          fontSize: 12)),
                  position.when(
                    data: (d) => Text(
                      '${d.inMinutes.toString().padLeft(2, '0')}:${(d.inSeconds % 60).toString().padLeft(2, '0')}',
                      style: GoogleFonts.chivoMono(
                          color: Colors.white,
                          fontSize: 18,
                          fontWeight: FontWeight.bold),
                    ),
                    loading: () => const Text('--:--',
                        style: TextStyle(color: Colors.white)),
                    error: (_, __) => const Text('--:--',
                        style: TextStyle(color: Colors.white)),
                  ),
                ],
              ),
              // Visualizer
              _buildAnimatedVisualizer(),
              // Format Tags
              Row(
                children: [
                  _buildTag('HQ', Colors.cyan),
                  const SizedBox(width: 4),
                  _buildTag('320', Colors.purple),
                ],
              )
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildTag(String text, Color color) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
      decoration: BoxDecoration(
        color: color.withOpacity(0.2),
        borderRadius: BorderRadius.circular(4),
        border: Border.all(color: color.withOpacity(0.5)),
      ),
      child: Text(text,
          style: GoogleFonts.rajdhani(
              color: color, fontSize: 10, fontWeight: FontWeight.bold)),
    );
  }

  Widget _buildSyncedLyricsPanel(
      AsyncValue<dynamic> lyricsQuery, AsyncValue<Duration> position) {
    return lyricsQuery.when(
      data: (lyrics) {
        final list = lyrics?.lyrics ?? [];
        if (list.isEmpty)
          return const Center(
              child: Text('Instrumental',
                  style: TextStyle(color: Colors.white38)));

        final currentMs =
            position.maybeWhen(data: (d) => d.inMilliseconds, orElse: () => 0);
        int currentIndex = 0;
        for (int i = 0; i < list.length; i++) {
          if (list[i].time.inMilliseconds <= currentMs)
            currentIndex = i;
          else
            break;
        }

        return Center(
          child: AnimatedSwitcher(
            duration: const Duration(milliseconds: 300),
            child: Text(
              list[currentIndex].text,
              key: ValueKey(currentIndex),
              textAlign: TextAlign.center,
              style: GoogleFonts.outfit(
                color: Colors.amber[300],
                fontSize: 26,
                fontWeight: FontWeight.w600,
                shadows: [
                  BoxShadow(
                      color: Colors.amber.withOpacity(0.4), blurRadius: 12)
                ],
              ),
            ),
          ),
        );
      },
      loading: () => const Center(
          child: SizedBox(
              height: 20,
              width: 20,
              child: CircularProgressIndicator(strokeWidth: 2))),
      error: (_, __) => const SizedBox.shrink(),
    );
  }

  Widget _buildControlsPanel(AsyncValue<PlaylistMode> loopMode,
      AsyncValue<Duration> position, AsyncValue<bool> playing) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceEvenly,
      children: [
        _buildGlassButton(Icons.skip_previous_rounded,
            () => audioPlayer.skipToPrevious(), 50),
        playing.when(
          data: (isPlaying) => _buildPlayButton(isPlaying),
          loading: () => _buildPlayButton(false),
          error: (_, __) => _buildPlayButton(false),
        ),
        _buildGlassButton(
            Icons.skip_next_rounded, () => audioPlayer.skipToNext(), 50),
      ],
    );
  }

  Widget _buildGlassButton(IconData icon, VoidCallback onTap, double size) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        width: size,
        height: size,
        decoration: BoxDecoration(
          shape: BoxShape.circle,
          color: Colors.white.withOpacity(0.1),
          border: Border.all(color: Colors.white.withOpacity(0.15)),
        ),
        child: Icon(icon, color: Colors.white, size: size * 0.5),
      ),
    );
  }

  Widget _buildPlayButton(bool isPlaying) {
    return GestureDetector(
      onTap: () => isPlaying ? audioPlayer.pause() : audioPlayer.resume(),
      child: Container(
        width: 75,
        height: 75,
        decoration: BoxDecoration(
          shape: BoxShape.circle,
          gradient: LinearGradient(
            colors: isPlaying
                ? [Colors.amber[300]!, Colors.amber[500]!]
                : [Colors.grey[800]!, Colors.grey[900]!],
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
          ),
          boxShadow: [
            BoxShadow(
              color: (isPlaying ? Colors.amber : Colors.black).withOpacity(0.4),
              blurRadius: 20,
              offset: const Offset(0, 8),
            )
          ],
        ),
        child: Icon(
          isPlaying ? Icons.pause_rounded : Icons.play_arrow_rounded,
          color: isPlaying ? Colors.black : Colors.white,
          size: 40,
        ),
      ),
    );
  }

  Widget _buildAnimatedVisualizer() {
    return SizedBox(
      height: 30,
      width: 60,
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceEvenly,
        children:
            List.generate(4, (index) => _AnimatedVisualizerBar(index: index)),
      ),
    );
  }
}

// =============================================================================
// HELPER WIDGETS
// =============================================================================

class _AnimatedVisualizerBar extends StatefulWidget {
  final int index;
  const _AnimatedVisualizerBar({required this.index});

  @override
  State<_AnimatedVisualizerBar> createState() => _AnimatedVisualizerBarState();
}

class _AnimatedVisualizerBarState extends State<_AnimatedVisualizerBar>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: Duration(milliseconds: 200 + (widget.index * 100)),
      vsync: this,
    )..repeat(reverse: true);
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        return Container(
          width: 6,
          height: 10 + (_controller.value * 15),
          decoration: BoxDecoration(
            color: Colors.amber[400]!.withOpacity(0.8),
            borderRadius: BorderRadius.circular(3),
          ),
        );
      },
    );
  }
}

// =============================================================================
// PAINTERS (THE VINYL TEXTURE)
// =============================================================================

class HighFidelityVinylPainter extends CustomPainter {
  @override
  void paint(Canvas canvas, Size size) {
    final center = Offset(size.width / 2, size.height / 2);
    final radius = size.width / 2;

    // 1. Draw Grooves (Micro-texture)
    final groovePaint = Paint()
      ..color = const Color(0xFF222222)
      ..style = PaintingStyle.stroke
      ..strokeWidth = 0.8;

    for (double r = radius * 0.38; r < radius * 0.98; r += 2.0) {
      canvas.drawCircle(center, r, groovePaint);
    }

    // 2. Anisotropic Highlight (The "V" shape light reflection)
    final sheenPaint = Paint()
      ..shader = ui.Gradient.sweep(
        center,
        [
          Colors.transparent,
          Colors.white.withOpacity(0.08),
          Colors.transparent,
          Colors.transparent,
          Colors.white.withOpacity(0.08),
          Colors.transparent,
        ],
        [0.0, 0.15, 0.3, 0.5, 0.65, 0.8],
        TileMode.clamp,
        0,
        math.pi * 2,
      );

    canvas.drawCircle(center, radius, sheenPaint);
  }

  @override
  bool shouldRepaint(CustomPainter oldDelegate) => false;
}
